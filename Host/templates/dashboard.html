<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Ink Dashboard v18 (Padding Update)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/weather-icons/2.0.10/css/weather-icons.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;600;700&family=Roboto:wght@400;500;600;700&display=swap');

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #FFFFFF;
            color: #181818;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-weight: 500;
        }

        * {
            box-sizing: border-box;
        }

        .dashboard-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            gap: 20px;
            /* Increased side padding to 5% to push content in */
            padding: 3% 5%;
            background-color: #FFFFFF;
        }

        /* --- WEEK VIEW (TOP) --- */
        .week-view-panel {
            flex-basis: 40%;
            flex-grow: 0;
            display: flex;
            flex-direction: column;
            background-color: #FFFFFF;
            border-radius: 12px;
            border: 1px solid #D0D0D0;
            overflow: hidden;
        }
        .week-view-header {
            font-family: "Google Sans", "Product Sans", sans-serif;
            font-size: 2.2rem; font-weight: 600; padding: 8px 20px;
            color: #202020; text-align: center; border-bottom: 1px solid #D0D0D0;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .week-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; padding: 8px; flex-grow: 1; }
        .day-cell { padding: 8px; display: flex; flex-direction: column; overflow: hidden; border-radius: 10px; border: 1px solid #C8C8C8; }
        .day-cell.center-0 { background-color: #B0B0B0; border-color: #909090; }
        .day-cell.center-0 * { color: #000000 !important; }
        .day-cell.center-1 { background-color: #C8C8C8; border-color: #A8A8A8; }
        .day-cell.center-2 { background-color: #E0E0E0; border-color: #C0C0C0; }

        .day-cell-header { display: flex; flex-direction: column; align-items: center; margin-bottom: 6px; padding-bottom: 4px; border-bottom: 1px solid rgba(0,0,0,0.1); }
        .day-name { font-size: 1.6rem; font-weight: 600; }
        .day-date { font-size: 1.2rem; color: #383838; }

        .day-weather-details { display: flex; gap: 8px; margin-bottom: 8px; align-items: stretch; flex-grow: 0; min-height: 45px; }
        .weather-info-box { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2px; border-radius: 8px; background-color: #FFFFFF; border: 1px solid #C0C0C0; text-align: center; }

        .temp-box .wi { font-size: 1.8rem; margin-bottom: 2px; }
        .weather-temps { font-size: 1.4rem; line-height: 1.1; font-weight: 500; }
        .uv-box .uv-label { font-size: 1.0rem; margin-bottom: 1px; }
        .uv-box .uv-value { font-size: 1.5rem; font-weight: 600; }

        .day-events { flex-grow: 1; overflow: hidden; display: flex; flex-direction: column; }
        .day-events ul {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 4px;
            align-items: flex-start;
        }
        .day-events li {
            font-size: 1.1rem;
            line-height: 1.2;
            background-color: #E8E8E8;
            color: #000;
            padding: 4px 8px;
            border-radius: 12px;
            border-bottom-left-radius: 4px;
            max-width: 100%;
            word-wrap: break-word;
            width: fit-content;
        }
        .day-cell.center-0 .day-events li { background-color: #FFFFFF; border: 1px solid #999; }

        /* --- BOTTOM SECTION: SPLIT PORTFOLIO & NEWS --- */
        .stats-section-wrapper {
            flex-grow: 1;
            display: flex;
            flex-direction: row;
            gap: 20px;
            overflow: hidden;
        }

        /* LEFT: Detailed Networth Panel */
        .networth-detailed-panel {
            flex-basis: 65%;
            display: flex;
            flex-direction: column;
            background-color: #F8F8F8;
            border-radius: 12px;
            border: 1px solid #C0C0C0;
            padding: 15px;
            overflow: hidden;
        }

        .networth-header {
            display: flex; justify-content: space-between; align-items: flex-end;
            border-bottom: 2px solid #D0D0D0;
            padding-bottom: 6px; margin-bottom: 8px;
        }
        .networth-title { font-family: "Google Sans", sans-serif; font-size: 1.8rem; font-weight: 600; color: #202020; margin-bottom: 2px;}
        .networth-total-value { font-family: "Google Sans", sans-serif; font-size: 2.8rem; font-weight: 700; color: #101010; line-height: 1; }
        .networth-delta { font-size: 1.4rem; font-weight: 600; color: #505050; margin-left: 10px; }

        .portfolio-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            overflow-y: auto;
            align-content: start;
        }

        .account-group {
            background-color: #FFFFFF;
            border: 1px solid #D0D0D0;
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 0px;
            break-inside: avoid;
            display: flex; flex-direction: column;
        }

        .account-group-title {
            font-size: 1.1rem; font-weight: 700; color: #444; border-bottom: 1px solid #EEE;
            padding-bottom: 4px; margin-bottom: 6px; text-transform: uppercase;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        .holdings-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        .holdings-table th { text-align: left; font-size: 0.8rem; color: #888; font-weight: 500; padding-bottom: 4px; }
        .holdings-table td { font-size: 1.0rem; padding: 2px 0; vertical-align: top; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .col-sym { font-weight: 600; width: 40%; }
        .col-pct { text-align: right; width: 25%; font-family: 'Roboto', monospace; }
        .col-val { text-align: right; width: 35%; font-family: 'Roboto', monospace; font-weight: 600; }

        .pos-gain { color: #2e7d32; }
        .neg-gain { color: #c62828; }
        .neutral-gain { color: #666; }

        /* RIGHT: News & Events Panel */
        .right-info-panel {
            flex-basis: 35%;
            display: flex;
            flex-direction: column;
            gap: 15px;
            min-height: 0;
        }

        .info-sub-panel {
            flex: 1;
            padding: 12px 15px;
            background-color: #F0F0F0; border-color: #D0D0D0;
            border-radius: 12px; border: 1px solid #C8C8C8;
            overflow: hidden;
            display: flex; flex-direction: column;
        }

        .info-panel-header {
            font-family: "Google Sans", "Product Sans", sans-serif;
            font-size: 1.6rem; font-weight: 600; padding-bottom: 6px; margin-bottom: 6px;
            color: #202020; text-align: left; border-bottom: 1px solid #D0D0D0;
            text-transform: uppercase; letter-spacing: 0.5px;
            flex-shrink: 0;
            display: flex; justify-content: space-between; align-items: center;
        }

        .upcoming-events-list {
            list-style: none; padding: 0; margin: 0;
            overflow: hidden;
            display: flex; flex-direction: column; gap: 6px;
        }
        .upcoming-event-item {
            background-color: #FFFFFF;
            padding: 4px 8px;
            border-radius: 6px;
            border: 1px solid #D0D0D0;
            font-size: 1.2rem;
            line-height: 1.2;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .upcoming-date-prefix { font-weight: 600; font-size: 1.1rem; margin-right: 4px; color: #333; }

        .news-list {
            list-style: none; padding: 0; margin: 0;
            display: flex; flex-direction: column; gap: 6px;
            overflow: hidden;
        }
        .news-item {
            background-color: #FFFFFF;
            padding: 4px 8px;
            border-radius: 6px;
            border: 1px solid #D0D0D0;
            font-size: 1.2rem;
            line-height: 1.3;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
        }

        .system-status { flex-shrink: 0; text-align: center; font-size: 1.0rem; color: #888; margin-top: 5px; }
        .no-data-msg { font-style: italic; color: #777; font-size: 1.1rem; padding: 5px; }

    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Week View -->
        <div class="week-view-panel">
            <div class="week-view-header">Week Overview</div>
            <div class="week-grid" id="week-grid-content"></div>
        </div>

        <!-- Bottom Section: Portfolio (Left) + News/Events (Right) -->
        <div class="stats-section-wrapper">

            <!-- Left: Detailed Portfolio -->
            <div class="networth-detailed-panel">
                <div class="networth-header">
                    <div style="display:flex; flex-direction:column;">
                        <div class="networth-title">Portfolio</div>
                        <div class="networth-delta" id="header-delta">--</div>
                    </div>
                    <div class="networth-total-value" id="header-total">--</div>
                </div>

                <div class="portfolio-grid" id="portfolio-content">
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; font-size: 1.5rem; color: #888;">
                        Loading Portfolio Data...
                    </div>
                </div>
            </div>

            <!-- Right: News & Events -->
            <div class="right-info-panel">
                <!-- Top Right: Upcoming Events -->
                <div class="info-sub-panel" id="upcoming-events-panel">
                    <div class="info-panel-header">Upcoming Events</div>
                    <ul id="upcoming-events-list" class="upcoming-events-list">
                        <li class="no-data-msg">Loading events...</li>
                    </ul>
                </div>

                <!-- Bottom Right: News -->
                <div class="info-sub-panel" id="news-panel">
                    <div class="info-panel-header">News <span style="font-size: 0.7em; font-weight: 400; color: #666;">BBC World</span></div>
                    <ul id="news-list" class="news-list">
                        <li class="no-data-msg">Loading news...</li>
                    </ul>
                </div>
            </div>

        </div>

        <div class="system-status">
            Last Update: <span id="updated">--</span>
        </div>
    </div>

    <script>
    const customIconToWiClass = { 'sun': 'wi-day-sunny', 'mostly_sun': 'wi-day-sunny-overcast', 'cloud': 'wi-cloudy', 'fog': 'wi-fog', 'drizzle': 'wi-sprinkle', 'shower': 'wi-showers', 'rain': 'wi-rain', 'snow': 'wi-snow', 'storm': 'wi-thunderstorm', 'unknown': 'wi-na' };
    const fmtCurrency = n => n == null ? '--' : new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(n);
    const fmtPct = n => {
        if (n == null) return '--';
        const s = n > 0 ? '+' : '';
        return s + n.toFixed(2) + '%';
    };

    function getDayCellClass(dayOffsetFromToday) { return `center-${Math.abs(dayOffsetFromToday)}`; }

    // --- Week View Logic ---
    async function updateCombinedWeekView() {
        try {
            const [weatherResp, eventsResp] = await Promise.all([
                fetch('/api/weather').catch(e => null),
                fetch('/api/calendar').catch(e => null)
            ]);
            if (!weatherResp || !weatherResp.ok) return;
            const weatherData = await weatherResp.json();
            let eventsData = { events: [] };
            if (eventsResp && eventsResp.ok) eventsData = await eventsResp.json();

            let html = "";
            const todayBase = new Date(); todayBase.setHours(0, 0, 0, 0);

            for (let dayOffset = -2; dayOffset <= 2; dayOffset++) {
                const array_idx = dayOffset + 2;
                const currentDate = new Date(todayBase); currentDate.setDate(todayBase.getDate() + dayOffset);
                const currentDateStr = currentDate.toISOString().split('T')[0];
                const dayWeather = weatherData.forecast[array_idx];
                const dayEvents = (eventsData.events || []).filter(e => e.date === currentDateStr);
                const dayCellClasses = ['day-cell', getDayCellClass(dayOffset)];
                let dayLabel = currentDate.toLocaleDateString(undefined, { weekday: 'short' }).toUpperCase();
                if (dayOffset === 0) dayLabel = "TODAY"; else if (dayOffset === 1) dayLabel = "TMRW";

                const month = currentDate.getMonth();
                const isWinter = [10, 11, 0, 1, 2].includes(month);

                html += `<div class="${dayCellClasses.join(' ')}"> <div class="day-cell-header"> <span class="day-name">${dayLabel}</span> <span class="day-date">${currentDate.toLocaleDateString(undefined, { month: 'short', day: 'numeric' })}</span> </div>`;
                html += `<div class="day-weather-details">`;
                const weatherIconClass = (dayWeather && dayWeather.icon) ? customIconToWiClass[dayWeather.icon] : customIconToWiClass['unknown'];
                html += `<div class="weather-info-box temp-box"> <i class="wi ${weatherIconClass}"></i>`;
                if (dayWeather && dayWeather.max !== null) html += `<div class="weather-temps">${Math.round(dayWeather.max)}° <span style="font-size:0.8em; color:#555;">/ ${Math.round(dayWeather.min)}°</span></div>`;
                else html += `<div class="weather-temps">N/A</div>`;
                html += `</div>`;

                html += `<div class="weather-info-box uv-box">`;
                if (isWinter) {
                    html += `<div class="uv-label">Snow</div>`;
                    let snowVal = (dayWeather && dayWeather.snow_sum) ? dayWeather.snow_sum : 0.0;
                    html += `<div class="uv-value">${snowVal.toFixed(1)}<span style="font-size:0.6em;">"</span></div>`;
                } else {
                    html += `<div class="uv-label">Max UV</div>`;
                    if (dayWeather && dayWeather.uv_index_max !== null) html += `<div class="uv-value">${Math.round(dayWeather.uv_index_max)}</div>`;
                    else html += `<div class="uv-value" style="color:#777">N/A</div>`;
                }
                html += `</div></div>`;

                html += `<div class="day-events"><ul>`;
                if (dayEvents.length > 0) { dayEvents.slice(0, 3).forEach(event => { html += `<li><span style="font-weight:600">${event.time || ''}</span> ${event.title}</li>`; }); }
                html += `</ul></div></div>`;
            }
            document.getElementById('week-grid-content').innerHTML = html;
        } catch (error) { console.error(error); }
    }

    // --- Detailed Networth Logic ---
    function renderHoldingsTable(holdings) {
        if (!holdings || holdings.length === 0) return '<div style="padding:5px; color:#888; font-style:italic;">No holdings</div>';
        let rows = holdings.map(h => {
            const gainClass = h.pct_gain > 0 ? 'pos-gain' : (h.pct_gain < 0 ? 'neg-gain' : 'neutral-gain');
            return `<tr>
                <td class="col-sym">${h.symbol}</td>
                <td class="col-pct ${gainClass}">${fmtPct(h.pct_gain)}</td>
                <td class="col-val">${fmtCurrency(h.value)}</td>
            </tr>`;
        }).join('');
        return `<table class="holdings-table"><thead><tr><th>Holding</th><th style="text-align:right">Total Gain</th><th style="text-align:right">Value</th></tr></thead><tbody>${rows}</tbody></table>`;
    }

    function updateNetworth() {
        fetch('/api/data')
            .then(res => res.json())
            .then(d => {
                if (d.error || d.net_worth === null) {
                    if (d.error) document.getElementById('header-total').textContent = "ERROR";
                    return;
                }

                // Header
                document.getElementById('header-total').textContent = fmtCurrency(d.net_worth);
                const val = d.change || 0;
                let deltaText = val > 0 ? '▲ +' + fmtCurrency(val).replace('$','') : (val < 0 ? '▼ ' + fmtCurrency(val) : '–');
                document.getElementById('header-delta').textContent = deltaText + " vs Yesterday";

                document.getElementById('updated').textContent = d.last_updated;

                // Details Grid
                const details = d.details;
                if (!details) return;

                let html = '';

                // 1. Fidelity Accounts
                if (details.fidelity) {
                    details.fidelity.forEach(acc => {
                        html += `<div class="account-group">
                            <div class="account-group-title">Fidelity - ${acc.name}</div>
                            ${renderHoldingsTable(acc.holdings)}
                        </div>`;
                    });
                }

                // 2. Robinhood
                if (details.robinhood && details.robinhood.length > 0) {
                    html += `<div class="account-group">
                        <div class="account-group-title">Robinhood</div>
                        ${renderHoldingsTable(details.robinhood)}
                    </div>`;
                }

                // 3. Non-Fidelity (Cash/Others)
                if (details.non_fidelity && details.non_fidelity.length > 0) {
                    html += `<div class="account-group">
                        <div class="account-group-title">Non-Fidelity / Cash</div>
                        <table class="holdings-table">
                            <thead><tr><th>Account</th><th style="text-align:right"></th><th style="text-align:right">Balance</th></tr></thead>
                            <tbody>
                                ${details.non_fidelity.map(acc => `<tr><td class="col-sym" colspan="2" style="font-weight:400; white-space:normal;">${acc.name}</td><td class="col-val">${fmtCurrency(acc.value)}</td></tr>`).join('')}
                            </tbody>
                        </table>
                    </div>`;
                }

                document.getElementById('portfolio-content').innerHTML = html;
            })
            .catch(e => console.error("Data fetch error:", e));
    }

    function updateUpcomingEvents() {
        fetch('/api/upcoming_events')
            .then(res => res.json())
            .then(data => {
                const listElement = document.getElementById('upcoming-events-list');
                if (!data || !data.events || data.events.length === 0) {
                    listElement.innerHTML = `<li class="no-data-msg">No upcoming events.</li>`;
                    return;
                }
                let html = '';
                // Limit to 4 to save space
                data.events.slice(0, 4).forEach(event => {
                    const eventDate = new Date(event.date + 'T12:00:00Z');
                    const datePrefix = eventDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', timeZone: 'UTC' });

                    html += `<li class="upcoming-event-item">
                                <span class="upcoming-date-prefix">${datePrefix}:</span>
                                ${event.title}
                            </li>`;
                });
                listElement.innerHTML = html;
            })
            .catch(e => {
                document.getElementById('upcoming-events-list').innerHTML = `<li class="no-data-msg">Error loading events.</li>`;
            });
    }

    function updateNews() {
        fetch('/api/news')
            .then(res => res.json())
            .then(data => {
                const listElement = document.getElementById('news-list');
                if (!data || !data.news || data.news.length === 0) {
                    listElement.innerHTML = `<li class="no-data-msg">No news available.</li>`;
                    return;
                }
                let html = '';
                data.news.forEach(item => {
                    html += `<li class="news-item">➤ ${item.title}</li>`;
                });
                listElement.innerHTML = html;
            })
            .catch(e => {
                document.getElementById('news-list').innerHTML = `<li class="no-data-msg">Error loading news.</li>`;
            });
    }

    function initializeDashboard() {
        updateCombinedWeekView();
        updateNetworth();
        updateUpcomingEvents();
        updateNews();

        setInterval(updateCombinedWeekView, 15 * 60 * 1000);
        setInterval(updateNetworth, 5 * 60 * 1000);
        setInterval(updateUpcomingEvents, 15 * 60 * 1000);
        setInterval(updateNews, 30 * 60 * 1000);
    }
    document.addEventListener('DOMContentLoaded', initializeDashboard);
    </script>
</body>
</html>